# Replugin分析（2）
```plantuml
class RePluginClassLoader {
ClassLoader mOrig
Method findResourceMethod;
Method findResourcesMethod;
Method findLibraryMethod;
Method getPackageMethod;
loadClass()
findResource()
findLibrary()
getPackage()
}
class PluginDexClassLoader {
ClassLoader mHostClassLoader
loadClass()
}
class BaseDexClassLoader
class PathClassLoader

class DexClassLoader
PathClassLoader <|-- RePluginClassLoader
BaseDexClassLoader <|-- PathClassLoader
BaseDexClassLoader <|-- DexClassLoader
DexClassLoader <|-- PluginDexClassLoader
```
RePluginClassLoader先加载插件中的类，之后在调用原来的classloader加载。

```java
    @Override
    protected Class<?> loadClass(String className, boolean resolve) 
    throws ClassNotFoundException {
        Class<?> c = null;
        c = PMF.loadClass(className, resolve);
        if (c != null) {
            return c;
        }
        try {
            c = mOrig.loadClass(className);
            return c;
        } catch (Throwable e) {
            //
        }
        return super.loadClass(className, resolve);
    }
```
```java
// PMF.init(application)
// PatchClassLoaderUtils.patch(application);
public static boolean patch(Application application) {
    Context oBase = application.getBaseContext();
    Object oPackageInfo = FieldUtils.readField(oBase, "mPackageInfo", true);
    ClassLoader oClassLoader = (ClassLoader) FieldUtils.readField(oPackageInfo, "mClassLoader", true);
    ClassLoader cl = new RePluginClassLoader(parent, original);
    FieldUtils.writeField(oPackageInfo, "mClassLoader", cl, true);
    Thread.currentThread().setContextClassLoader(cl);
}
```

