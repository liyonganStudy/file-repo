### 功能需求
* 服务端记录用户通过任意端对于每一个节目的最新收听进度书签（用户拖动进度也算收听）。
	- 如发现服务端与客户端收听进度不同，则选择播放结束时间距当前最近的内容，同时将服务端状态更新（如用户在离线状态下收听已下载部分）。
	- 特别的，对已播完的内容做特殊处理，继续播放不再将书签状态更新为未播完。
* 下载和电台详情点击节目
	- 用户主动点击播放未听完节目时，自动索引到已听内容的最后倒数3s时间并继续往后播。
	- 用户主动点击播放未听完节目时，自动索引到已听内容的最后倒数3s时间并继续往后播。
	- 如该节目已听完，则无论点击还是自动，均从头播放。
* 在其他地方点击节目
	- 其余的地方点击播放电台可以不读取服务端和客户端本地进度。

### 客户端方案
* 在数据库中记录每个用户每个节目的最后播放进度，每条记录包含最后播放进度、最后播放进度记录的时间、是否播完过三个字段。
* 在每次进入下载的节目列表页面和电台详情页面时都会从服务器获取最新的播放进度记录，并更新到本地数据库，更新是需要对比服务端进度记录的时间和本地进度记录的时间。
* 在每次节目进度改变、节目切换、程序退出的时间点更新数据库中的播放进度记录，并同时发送给服务端，如果发送失败不重试。同时发送广播更新UI进程中数据和UI。
* ~~客户端在每次播放节目时都会去查询本地数据库获取播放进度记录，并应用~~，使用上面方案不需要在播放节目时查询。

### 客户端实现
#### 从服务端获取数据
* 详情页根据电台id获取：/api/dj/playrecord/radio/get
* 下载根据节目ids获取：/api/dj/playrecord/prog

#### 网络数据和本地数据合并
获取到网络数据后通过DBManager合并，下载如果没有获得网络数据直接使用本地数据库记录。
```java
DBManager.getInstance().getProgramPlayRecords((List<ProgramPlayRecord>) result[1])
```
#### 接收播放进度变化广播
使用全局广播接收并更新数据和UI，例如：
```java
    private BroadcastReceiver playRecordChangeReceiver = new BroadcastReceiver() {
        @Override
        public void onReceive(Context context, Intent intent) {
            if (intent.getAction().equals(NeteaseMusicConst.BROADCAST_ACTIONS.PROGRAM_PLAY_RECORD_CHANGE)) {
                if (intent.getLongExtra(NeteaseMusicConst.NETEASE_MUSIC_INTENT_KEY.USER_ID, 0) == Session.getInstance().getUserId()) {
                    mRadioDetailProgramAdapter.updatePlayRecord(intent.getLongExtra(NeteaseMusicConst.NETEASE_MUSIC_INTENT_KEY.PROGRAM_ID, 0), intent.getIntExtra(NeteaseMusicConst.NETEASE_MUSIC_INTENT_KEY.TARGET_POSITION, 0), intent.getBooleanExtra(NeteaseMusicConst.NETEASE_MUSIC_INTENT_KEY.IS_COMPLETED, false));
                }
            }
        }
    };

	public void updatePlayRecord(long programId, int playPosition, boolean isComplete) {
		ProgramPlayRecord localRecord = mProgramPlayRecordMap.get(programId);
		if (localRecord != null && !localRecord.isComplete()) {
			localRecord.setPlayPostion(playPosition);
			localRecord.setComplete(isComplete);
			notifyDataSetChanged();
		}
	}
```
#### 详情页和下载处节目播放
使用如下方法并传递相应时间
```java
public static void startPlayPrograms(Context context, ArrayList<Program> programs, int pos, PlayExtraInfo extra, boolean isNeedReverse, int playPosition)

int playPosition = programPlayRecord == null ? 0 : programPlayRecord.getTargetPlayPosition()
```