# Replugin分析(4)
[TOC]
## 插件apk的安装
```java
PluginInfo info = RePlugin.install(pluginFilePath);
==>
MP.pluginDownloaded(path)
==>
PluginInfo info = PluginProcessMain.getPluginHost().pluginDownloaded(path);
==>
PluginManagerServer.this.installLocked(path);
```
```java
private PluginInfo installLocked(String path) {
    // 1. 读取APK内容
    PackageInfo pi = mContext.getPackageManager().getPackageArchiveInfo(path, flags);
    // 2. 校验插件签名
    // 3. 解析出名字和三元组
    PluginInfo instPli = PluginInfo.parseFromPackageInfo(pi, path);
    // 4. 将合法的APK改名后，移动（或复制，见RePluginConfig.isMoveFileWhenInstalling）到新位置
    copyOrMoveApk(path, instPli)
    // 5. 从插件中释放 So 文件
    PluginNativeLibsHelper.install(instPli.getPath(), instPli.getNativeLibsDir());
    // 6. 若已经安装旧版本插件，则尝试更新插件信息，否则直接加入到列表中
    if (curPli != null) {
        updateOrLater(curPli, instPli);
    } else {
        mList.add(instPli);
    }
    // 7. 保存插件信息到文件中，下次可直接使用
    mList.save(mContext);
}
```
## 启动Activity
```java
RePlugin.startActivity(MainActivity.this, RePlugin.createIntent(info.getName(), "com.qihoo360.replugin.sample.demo3.MainActivity"));
==>
mPluginLibraryInternalProxy.startActivity
==>
ComponentName cn = mPluginMgr.mLocal.loadPluginActivity(intent, plugin, activity, process);
context.startActivity(intent);
==>

替换ComponentName指向坑位Activity并保存原ComponentName信息
PluginCommImpl.loadPluginActivity
==>
ActivityInfo ai = getActivityInfo(plugin, activity, intent);
Plugin p = mPluginMgr.loadAppPlugin(plugin);
==>
// 容器选择（启动目标进程）
IPluginClient client = MP.startPluginProcess(plugin, process, info);
==>
// 远程分配坑位
container = client.allocActivityContainer(plugin, process, ai.name, intent);

```
```java
public boolean startActivity(Context context, Intent intent, String plugin, String activity, int process, boolean download) {
    // 获取坑位activity对应的ComponentName
    ComponentName cn = mPluginMgr.mLocal.loadPluginActivity(intent, plugin, activity, process);
    context.startActivity(intent);
```
```java
// PluginCommImpl
public ComponentName loadPluginActivity(Intent intent, String plugin, String activity, int process) {
    ActivityInfo ai = getActivityInfo(plugin, activity, intent);
    // 容器选择（启动目标进程）
    IPluginClient client = MP.startPluginProcess(plugin, process, info);
    // 远程分配坑位
    container = client.allocActivityContainer(plugin, process, ai.name, intent);
    return new ComponentName(IPC.getPackageName(), container);
}
```




