# 4.3.3版本
[TOC]
## 付费直播
未知类型在web购买后是否可以发弹幕和彩色弹幕
后台文档：
https://note.youdao.com/share/?id=fdb474b99775b18b1cab92d9b9ed6a55

```java
http://igame.163.com/live?id=28001 已结束，但MV未入库
http://igame.163.com/live?id=29001普通会员
http://igame.163.com/live?id=31001 豪华会员
http://igame.163.com/live?id=24004 单次付费
http://igame.163.com/live?id=13002 免费
```
### 埋点
```
1.直播页曝光人数次数，区分直播前、直播中、直播后；区分免费直播、会员直播、豪华会员直播；
直播页曝光，进入直播页就打
action=impress, json={
resource='live',
resourceid='', 直播id
name='liveplay'
}

action=page, json={
resource='live',
resourceid='', 直播id 
type='free|vip|super', 类型：免费直播、会员直播、豪华会员直播
time='before|on|after', 时间：直播前、直播中、直播后
name='liveplay'
vip_status='-1|1|2|3', --当前会员状态，-1:非会员,1:普通会员,2:豪华会员,3:体验会员
}
2.豪华/会员直播中状态的页面，无权限点击购买会员按钮人数次数以及后续的付费流程转化率，区分2种会员，区分web端
action=click, json={
target='buyvip',
resource='live',
resourceid='', 直播id
time='before|on|after', 时间：直播前、直播中、直播后
type='vip|super', 类型：会员直播、豪华会员直播
name='liveplay'
vip_status='-1|1|2|3', --当前会员状态，-1:非会员,1:普通会员,2:豪华会员,3:体验会员
}
3.直播中点击发评论/弹幕输入框与实际发送的人数次数，与评论区打点相同，区分弹幕颜色、区分web端
点击发评论
action=click, json={
target='comment',
resource='live',
resourceid='', 直播id 
type='free|vip|super', 类型：免费直播、会员直播、豪华会员直播
time='before|on|after', 时间：直播前、直播中、直播后
name='liveplay',
color='' 弹幕颜色，传颜色十六进制值
}
4.直播中输入弹幕时点选彩色弹幕、由此跳转至会员页的人数次数、区分web端
action=click, json={
target='colorfont',
resource='live',
resourceid='', 直播id 
type='free|vip|super', 类型：免费直播、会员直播、豪华会员直播
time='on', 时间：直播中
name='liveplay',
vip_status='-1|1|2|3', --当前会员状态，-1:非会员,1:普通会员,2:豪华会员,3:体验会员
}
5.直播中关闭弹幕的人数次数，区分web端
action=click, json={
target='close_comment',
resource='live',
resourceid='', 直播id 
type='free|vip|super', 类型：免费直播、会员直播、豪华会员直播
time='on', 时间：直播中
name='liveplay'
}
6.直播分享、与各种分享途径的人数次数，区分web端
点击分享按钮
action=click, json={
type='share',
name='live',
resourceid='', 直播id
}
分享浮层中分享平台的点击
action=click, json={
target='share',
targetid='wxsession|wxtimeline|yxsession|yxtimeline|sina|tencent|qq|qzone|netease'
resource='live',
resourceid='', 直播id
}
7.切换清晰度，区分切换的具体清晰度，区分web端
action=click, json={
target='clarity',
targetid='', 标清|高清|超清|1080P，直接传文案
resource='live',
resourceid='', 直播id 
type='free|vip|super', 类型：免费直播、会员直播、豪华会员直播
time='on', 时间：直播中
name='liveplay'
vip_status='-1|1|2|3', --当前会员状态，-1:非会员,1:普通会员,2:豪华会员,3:体验会员
}
8.直播页面介绍tab曝光，直播页面详情tab点击查看歌手的人数次数
直播页面介绍tab曝光
action=impress, json={
target='detail',
resource='live',
resourceid='', 直播id 
type='free|vip|super', 类型：免费直播、会员直播、豪华会员直播
time='before|on|after', 时间：直播前、直播中、直播后
name='liveplay'
}
直播页面详情tab点击查看歌手
action=click, json={
target='singer_detail',
resource='live',
resourceid='', 直播id 
type='free|vip|super', 类型：免费直播、会员直播、豪华会员直播
time='before|on|after', 时间：直播前、直播中、直播后
name='liveplay'
}
9.直播后，通过直播页面进入MV页的人数次数，区分具体直播id，区分web和webview端，在离开直播页面时打
action=page, json={
type='mv',
id='', --mv的id
refer='live',
referid='', 直播id 
}
```
## ~~MV详情页展示相关音乐~~
jkl环境 qa环境也可以
/api/cloudvideo/v1/music/rcmd?id=1998&type=0

```
{"code":200,"data":[{"name":"やりたがり屋さん","id":22692545,"pst":0,"t":0,"ar":[{"id":21520,"name":"SDN48","tns":[],"alias":[]}],"alia":[],"pop":50,"st":0,"rt":"","fee":0,"v":19,"crbt":null,"cf":"","al":{"id":2082006,"name":"NEXT ENCORE","picUrl":"http:\/\/p1.music.126.net\/xUKX2mBLxsnL2wdT8Y4L6w==\/558551906931828.jpg","tns":[],"pic":558551906931828},"dt":233900,"h":{"br":320000,"fid":0,"size":9386340,"vd":-4.96},"m":{"br":160000,"fid":0,"size":4712512,"vd":-4.6},"l":{"br":96000,"fid":0,"size":2842563,"vd":-4.78},"a":null,"cd":"","no":14,"rtUrl":null,"ftype":0,"rtUrls":[],"djId":0,"copyright":0,"s_id":0,"cp":0,"mv":1998,"mst":9,"rurl":null,"rtype":0,"publishTime":1331654400007,"privilege":{"id":22692545,"fee":0,"payed":0,"st":0,"pl":320000,"dl":320000,"sp":7,"cp":1,"subp":1,"cs":false,"maxbr":320000,"fl":320000,"toast":false,"flag":0},"relatedVideo":[{"vid":"1998","coverUrl":"http:\/\/p1.music.126.net\/PMSgIYZWcBccMbhu_dwS2Q==\/6069304185323587.jpg","publishTime":1364227200000,"playTime":9248,"type":0,"title":"やりたがり屋さん"},{"vid":"E7DF614689E640985C1420FE0A57D6A5","coverUrl":"http:\/\/p1.music.126.net\/wR6o5dePMXdDxrdI7b5JNA==\/109951162992148001.jpg","publishTime":1501752883000,"playTime":4,"type":1,"title":"One Day\/One Hoosier with Ali Oppel - YouTube"},{"vid":"524116","coverUrl":"http:\/\/p1.music.126.net\/sdVjT167QCTmfr_BnM8SGA==\/3274345633327098.jpg","publishTime":1448380800000,"playTime":195,"type":0,"title":"Faded"}]}],"message":""}
```

### 埋点
```
相关音乐的曝光(新增)和点击(已有，新加songid字段)
action = impress|click
json = {
page = mvplay|videoplay mv播放页（详情页）|短视频播放页（详情页）
type = relatedmusic 相关音乐
id = mv的id|短视频id
alg = 推荐算法
isfullscreen = 1|2|0 当前处在横屏全屏播放页|竖屏全屏播放页|不在全屏播放页
songid = 相关音乐id
}
```

## ~~视频导流-评论~~
bbc 19292987L

```
{"code":200,"data":{"count":1,"video":{"playTime":4,"coverUrl":"http:\/\/p1.music.126.net\/wR6o5dePMXdDxrdI7b5JNA==\/109951162992148001.jpg","publishTime":1501752883000,"vid":"E7DF614689E640985C1420FE0A57D6A5","title":"One Day\/One Hoosier with Ali Oppel - YouTube","creator":{"nickname":"liuj测试","userId":119172001},"count":1},"type":4}}
```
### 埋点
```
评论页的视频曝光及点击
action = impress|click
page：comment；
id：被展示内容的id；
type：资源类型，video|mv；
resource：评论页所属资源的类型，现有song；
sourceid：评论页所属资源的id。
来自评论页的视频播放play和playend，已有埋点，主要字段取值如下：
source=comment，resource=song，resourceid=歌曲id。
```

## ~~视频导流-歌手页~~ 
def都可以测试

### 埋点
```
歌手页——视频曝光和点击
action = impress | click
json = {target = 'video', targetid = '', page = 'artist_video', pageid = ''}
target: 视频
targetid: 视频id
page: 歌手——视频tab页面
pageid: 歌手的艺人id

3. 歌手页——视频的筛选控件（曝光的点：只要不出这个页面，随屏幕滚来滚去曝光的话，只打曝光出来的第一次）
action = impress | click
json = {target = 'filter_all | filter_mv', targetid = 'button', page = 'artist_video', pageid = ''}

target: 筛选——全部 | 筛选——mv
targetid: 表示是按钮
page: 歌手——视频tab页面
pageid: 歌手的艺人id
```



## mv下架

```
// def环境
免费                        下载和观看      2992239012L ok
免费                          观看          2992239011L ok
免费                          下载          2992238011L ok
仅关联歌曲购买使用        下载和观看        2992239010L
仅关联歌曲购买使用           观看           2992237018L
仅关联歌曲购买使用           下载           2992237017
仅会员                    下载和观看        2992237016L ok
仅会员                     观看             2992237015L 
仅会员                     下载             2992237014L ok
仅豪华会员               下载和观看         2992237013L ok 
仅豪华会员                观看              2992237012L
仅豪华会员                下载              2992237011
仅mv付费使用             下载和观看        2992237010L
仅mv付费使用             观看              2992235014
仅mv付费使用             下载              2992235013
```
### 服务端逻辑
文档：
[https://g.hz.netease.com/cloudmusic/song-privilege/wikis/4.3.3-权限相关](https://g.hz.netease.com/cloudmusic/song-privilege/wikis/4.3.3-权限相关)

### 客户端逻辑

播放下载获取相关信息
**public MVUrlInfo getMVVideoInfo(long mvid, int br, boolean isPlayOrDownload)**

**public Object[] getMvDownloadInfo(long id, int bitrate)**
返回结果**new Object[]{data.getInt("code"), data.getString("url"), data.getInt("r"), data.getLong("size"), data.getInt("fee")**

### MVUrlInfo
##### 老版本MVUrlInfo返回格式
```java
{
    "id":5779168,
    "url":"http://v4c.music.126.net/20171228145351/3423b735d47d70203b6356a9fb25f7c6/cloudmusic/MDQxJiQwMCAiYTAjISAhMA==/mv/5779168/37133ac267fdebef609720b2e275c01b.mp4",
    "r":480,
    "size":33525257,
    "md5":"",
    "code":200,
    "expi":3600,
    "fee":0
}
```

##### 新版本MVUrlInfo返回格式
```java
{
    "id":5360057,
    "url":"http://v4.music.126.net/20171229151456/b02c7dfe1b2af51c4663f18841ce0136/cloudmusic/IiAxMDBiMyQ1JDAgICAgMg==/mv/5360057/425ccae4b00b7d6b39f1dcbdfaed8dfb.mp4?u=AFwcb8WI9DSsd8f/EILuWA==",
    "r":480,
    "size":35152568,
    "md5":"",
    "code":200,
    "expi":3600,
    "fee":0,
    "mvFee":0,
    "st":0,
    "msg":""
}
```

##### 老版本下载处理逻辑
DownloadMaster.downloadMV![屏幕快照 2017-12-28 下午5.15.23](media/15144345460167/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-12-28%20%E4%B8%8B%E5%8D%885.15.23.png)
![屏幕快照 2017-12-28 下午5.16.22](media/15144345460167/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-12-28%20%E4%B8%8B%E5%8D%885.16.22.png)



DownloadJob.getDownloadInfo
![屏幕快照 2017-12-28 下午2.29.14](media/15144345460167/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-12-28%20%E4%B8%8B%E5%8D%882.29.14.png)

相应弹框文案 DownloadingListAdapter
![屏幕快照 2017-12-28 下午2.32.39-w440](media/15144345460167/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-12-28%20%E4%B8%8B%E5%8D%882.32.39.png)

服务端下载会返回-110 code，表示版权原因无法下载，老版本没有

#### MVPrivilege

##### 老版本返回格式
```java
{
    "id":5779168,
    "fee":0,
    "payed":0,
    "pl":1080,
    "dl":1080,
    "cp":1,
    "sid":0,
    "normal":true,
    "unauthorized":false
}
```
##### 新版本返回格式
```java
{
    "id":5332022,
    "fee":0,
    "mvFee":0,
    "payed":0,
    "pl":1080,
    "dl":1080,
    "cp":1,
    "sid":0,
    "normal":true,
    "unauthorized":false
}
```

新增**mvFee**：根据mvFee字段来判断MV的付费类型，mvFee的不同的位代表不同的付费类型以及不同的播放下载权限（表示版权信息）。 只需要对以下任意一种类型进行付费就可以播放或下载。

* 高16位表示播放和下载 (表示版权信息)
    * 高16位不存在1 - 既可以播放也可以下载
    * 最低位为1  -  仅播放
    * 次低位为1  -  仅下载

通过MvPrivilege判断mv是否可以播放下载逻辑不变还是通过pl和dl判断即可。

```java
	  public boolean canPlayMv() {
        return playMaxLevel > 0;
    }

    public boolean canDownloadMv() {
        return downMaxLevel > 0;
    }

    public boolean canPlayCanNotDownload() {
        return playMaxLevel > 0 && downMaxLevel <= 0;
    }
```

通过mvFee和fee结合判断到底什么付费类型。


遇到不能识别付费类型调整webview地址： /v/m/order/confirm?type=xxx&id=xxx
type=mv，type=live

```
// def环境
免费                        下载和观看      2992239012
免费                          观看          2992239011
免费                          下载          2992238011 ok
仅关联歌曲购买使用        下载和观看        2992239010L
仅关联歌曲购买使用           观看           2992237018L
仅关联歌曲购买使用           下载           2992237017
仅会员                    下载和观看        2992237016L ok
仅会员                     观看             2992237015L 
仅会员                     下载             2992237014L ok
仅豪华会员               下载和观看         2992237013L ok 
仅豪华会员                观看              2992237012
仅豪华会员                下载              2992237011
仅mv付费使用             下载和观看        2992237010L
仅mv付费使用             观看              2992235014
仅mv付费使用             下载              2992235013
```

#### 老版本出现问题
[http://doc.hz.netease.com/pages/viewpage.action?pageId=100403191](http://doc.hz.netease.com/pages/viewpage.action?pageId=100403191)

1. 权限弹框
![屏幕快照 2018-01-08 上午10.27.57](media/15144345460167/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-01-08%20%E4%B8%8A%E5%8D%8810.27.57.png)
2. 播放url
![屏幕快照 2018-01-08 上午10.29.29](media/15144345460167/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-01-08%20%E4%B8%8A%E5%8D%8810.29.29.png)


##### 免费 能播不能下载 关联歌曲_下载 会员_下载 豪华会员_下载（老版本只能这样）
2992238011
playUrlInfo code=-125 提示播放失败
不是专辑歌曲，不是vip，会弹框提示去购买

##### 关联歌曲_下载观看 关联歌曲_观看（~~老逻辑有问题？~~）
~~fee=1，客户端有问题，可以使用不能识别的fee？~~
开通会员就可以听
2992239010L
playUrlInfo code=-105 提示付费使用
fee=1，泰勒歌曲，老逻辑提示购买会员
![屏幕快照 2018-01-08 上午10.42.16](media/15144345460167/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-01-08%20%E4%B8%8A%E5%8D%8810.42.16.png)

##### 豪华会员_观看下载 豪华会员_观看（现在是对的）
2992235012L
playUrlInfo code=-105 提示付费使用
fee是256，未知付费类型，提示订购
![屏幕快照 2018-01-08 上午10.47.39](media/15144345460167/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-01-08%20%E4%B8%8A%E5%8D%8810.47.39.png)

##### 仅关联歌曲购买使用 - 数字专辑单曲
320005L
playUrlInfo code=-105 提示付费使用
fee=1，泰勒歌曲，老逻辑提示购买会员
![屏幕快照 2018-01-08 上午10.42.16](media/15144345460167/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-01-08%20%E4%B8%8A%E5%8D%8810.42.16.png)

## ~~单曲评论广告对音乐人支持-android~~

## 评论页视频广告
```
0. 广告曝光，修改为每次曝光都打
action=adimpress, json={
page=comment,
resource='',
resourceid='',
id='', 广告id
url='', 广告url
position=''
}
1.展示分成文案时，广告曝光日志中打一个标志
action=adimpress, json={
page=comment,
resource='',
resourceid='',
id='', 广告id
url='', 广告url
position='',
divide=1 --分成标志
}
2.展示分成文案时，广告点击日志中打一个标志
action=adclick, json={
page=comment,
resource='',
resourceid='',
id='', 广告id
url='', 广告url
position='',
type='picture|detail'，图片|详情链接
divide=1 --分成标志
}
3. 点击广告主头像跳转至个人主页，区分用户和广告主id
action=click, json={
page='comment'
resource='song|djradio|dj|MV|video|list|album|event|topic' --'单曲|电台|节目|MV|视频|歌单|专辑|动态|专栏'
resourceid='' --资源id
id='' --广告id
url='' --广告url
position='' --在评论区位置，位置从1开始计数
type='userphoto' --广告主头像
divide=1 --分成标志
}
4. 点击广告标，区分用户id，区分广告id
action=click, json={
page='comment'
resource='song|djradio|dj|MV|video|list|album|event|topic' --'单曲|电台|节目|MV|视频|歌单|专辑|动态|专栏'
resourceid='' --资源id
id='' --广告id
url='' --广告url
position='' --在评论区位置，位置从1开始计数
type='ad_label' --广告标
divide=1 --分成标志
}
5. 点击点击不感兴趣，区分用户id，区分广告id
action=click, json={
page='comment'
resource='song|djradio|dj|MV|video|list|album|event|topic' --'单曲|电台|节目|MV|视频|歌单|专辑|动态|专栏'
resourceid='' --资源id
id='' --广告id
url='' --广告url
position='' --在评论区位置，位置从1开始计数
type='adlabel' --广告标
value='nointerest'
divide=1 --分成标志
}
6. 点击赞、取消赞，区分用户id，区分广告id(是否只有服务端能打)
action=click, json={
page='comment'
resource='song|djradio|dj|MV|video|list|album|event|topic' --'单曲|电台|节目|MV|视频|歌单|专辑|动态|专栏'
resourceid='' --资源id
id='' --广告id
url='' --广告url
position='' --在评论区位置，位置从1开始计数
type='zan|cancel_zan' --点击赞|取消赞
divide=1 --分成标志
}
```

## 视频详情页相关广告
### 埋点
```
1.相关推荐广告曝光 PV、UV，区分广告id
action=adimpress, json={
page=videoplay,
id='', 广告id
url='', 广告url
position='recommendvideo'
}
2.相关推荐广告点击 PV、UV，区分广告id
action=adclick, json={
page=videoplay,
id='', 广告id
url='', 广告url
position='recommendvideo'
}
```

## 电台打包购买
### 埋点
```
1.会员折扣电台支付浮层弹出PV/UV，上报用户会员状态（非会员、普通会员、豪华会员）、上报当前打包购买复选框的选中状态（选中、未选中）、电台id、userid
豪华会员折扣电台支付浮层触发埋点中加merge字段，表示打包购买复选框的选中状态
action=page, json={
id='' --电台id
discount=1,
source='dj',
radioid='',
type='buydj',
origin_price='',
sp_price='',
class='allchare',
status='-1|1|2|3', --当前会员状态，-1:非会员,1:普通会员,2:豪华会员,3:体验会员
merge='1选中|0未选中' 
}
2.畅享曲库等11项特权旁问号的点击PV/UV
action=click, json={
target='priority'
id='' --电台id
discount=1,
source='dj',
radioid='',
type='buydj',
origin_price='',
sp_price='',
class='allchare',
status='-1|1|2|3', --当前会员状态，-1:非会员,1:普通会员,2:豪华会员,3:体验会员
merge='1选中|0未选中' 
}
3.点击支付按钮的PV/UV，上报此时用户是否打包购买、电台id、userid
豪华会员折扣电台支付按钮点击埋点中增加merge字段，表示用户是否打包购买
action=click,json={
type=buydj,
id="", --电台id
class='allcharge',
price='', --价格
discount='1', --是否有折扣，1：有
status='-1|1|2|3', --当前会员状态，-1:非会员,1:普通会员,2:豪华会员,3:体验会员
paymethod='alipay|weixin|change' --支付方式, 零钱/微信/支付宝
merge='1选中|0未选中'
}
```

## 评论页资源歌手页调整
### 埋点
```
3. 评论页区分资源类型进入歌手页
action = 'click'
json = {target = 'artistname', targetid = '', resource = 'song | album | mv', resourceid = '', page = 'comment'}
target: 表示点击歌手名
targetid: 艺人id
resource: 表示资源，单曲|专辑|mv
resourceid: 资源id
page: 表示评论页
```


